name: 2. Deploy State

on:
  workflow_dispatch:
    # Optionale Eingabe, falls Sie die Run-ID des ersten Workflows benÃ¶tigen.

        
# Konkurrenz-Kontrolle: Stellt sicher, dass nur ein Workflow-Lauf gleichzeitig aktiv ist.
concurrency: 
  group: workflow_state_update
  cancel-in-progress: true 

env:
  ENC_KEY: ${{ secrets.STATE_ENCRYPTION_KEY }} # Encryption Key als Environment Variable
  
jobs:
  # Job 1: Alten State holen, entschlÃ¼sseln und VorprÃ¼fung durchfÃ¼hren
  prepare_assessment:
    runs-on: self-hosted
    permissions:
      contents: write 
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
        
      - name: Alten State holen & entschlÃ¼sseln
        run: |
          git fetch origin state-storage:state-storage || true
          git checkout state-storage -- state_file.enc 2>/dev/null || true
          git checkout main 

          if [ -f state_file.enc ]; then
            echo "Alten State entschlÃ¼sselt."
            openssl aes-256-cbc -d -a -in state_file.enc -out state_file.json -pass env:ENC_KEY
            rm state_file.enc
          fi


      - name: Kompilierung und Update der State-Datei
        # Ihr Hauptskript aktualisiert nun state_file.json (den NEUEN Zustand)
        run: echo "next" >> state_file.json
        
      - name: Neuen State verschlÃ¼sseln (Nur wenn geÃ¤ndert) ğŸ”’
        run: |
          mkdir -p output
          openssl aes-256-cbc -a -salt -in state_file.json -out output/state_file.enc -pass env:ENC_KEY
          
      - name: VerschlÃ¼sselten State auf separaten Branch pushen (Manueller Git-Block) ğŸ’¾
        run: |
          # 1. Konfiguration des Benutzers fÃ¼r den Commit
          git config user.name "State Update Bot"
          git config user.email "actions@github.com"
          
          # 2. Ziel-Branch holen (und Fehler ignorieren, falls er beim ersten Mal nicht existiert)
          git fetch origin state-storage:state-storage || true
          
          # 3. Zum State-Branch wechseln
          git checkout state-storage || git checkout --orphan state-storage
          
          # 4. Nur die State-Datei im Branch behalten (wichtig fÃ¼r Orphan Branches)
          git rm -rf .
          
          # 5. Neue verschlÃ¼sselte Datei kopieren
          cp output/state_file.enc .
          
          # 6. Datei hinzufÃ¼gen und committen
          git add state_file.enc
          git commit -m "Auto-update encrypted state [skip ci]"
          
          # 7. Pushen
          # Wichtig: Wir pushen direkt mit dem GITHUB_TOKEN
          git push origin state-storage
          
        env:
          # Wir verwenden den GITHUB_TOKEN als Environment Variable fÃ¼r die Authentifizierung
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
