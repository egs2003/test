name: VorprÃ¼fung

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - 'README.md'
      
# Konkurrenz-Kontrolle: Stellt sicher, dass nur ein Workflow-Lauf gleichzeitig aktiv ist.
concurrency: 
  group: workflow_state_update
  cancel-in-progress: true 

env:
  ENC_KEY: ${{ secrets.STATE_ENCRYPTION_KEY }} # Encryption Key als Environment Variable

jobs:
  # Job 1: Alten State holen, entschlÃ¼sseln und VorprÃ¼fung durchfÃ¼hren
  prepare_assessment:
    runs-on: self-hosted
    outputs:
      state_available: ${{ steps.fetch_state.outputs.state_available }}
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
        
      - name: Alten State holen & entschlÃ¼sseln
        id: fetch_state
        run: |
          git fetch origin state-storage:state-storage || true
          git checkout state-storage -- state_file.enc 2>/dev/null || true

          if [ -f state_file.enc ]; then
            echo "Alten State entschlÃ¼sselt."
            openssl aes-256-cbc -d -a -in state_file.enc -out state_file.json -pass env:ENC_KEY -pbkdf2
            rm state_file.enc
            echo "state_available=true" >> $GITHUB_OUTPUT
          fi

      - name: VorprÃ¼fung (EinschÃ¤tzung) durchfÃ¼hren
        # Ihr Skript liest state_file.json und schreibt eine EinschÃ¤tzung in assessment.txt
        run: |
          echo "# Last Result" > assessment.txt
          echo "test123" >> assessment.txt

      - name: State hochladen
        if: steps.fetch_state.outputs.state_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: klartext_state
          path: state_file.json
      
      - name: EinschÃ¤tzung hochladen (FÃ¼r die manuelle PrÃ¼fung)
        uses: actions/upload-artifact@v4
        with:
          name: assessment.txt
  manual_approval:
    needs: prepare_assessment
    runs-on: self-hosted
    environment: 
      name: approve
    steps:
      - name: EinschÃ¤tzung fÃ¼r Reviewer herunterladen
        uses: actions/download-artifact@v4
        with:
          name: assessment.txt
          
      - name: EinschÃ¤tzung im Log anzeigen
        run: cat assessment.txt
  compile_and_deploy:
    needs: manual_approval
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
        
      - name: Klartext-State herunterladen (vom Job 1)
        # Dieser Schritt wird nur ausgefÃ¼hrt, da der Job nur bei State-VerfÃ¼gbarkeit startet
        uses: actions/download-artifact@v4
        with:
          name: klartext_state
          path: .

      - name: Kompilierung und Update der State-Datei
        # Ihr Hauptskript aktualisiert nun state_file.json (den NEUEN Zustand)
        run: |
          date >> state_file.json
          cat state_file.json

      - name: Neuen State verschlÃ¼sseln (Nur wenn geÃ¤ndert) ğŸ”’
        run: |
          mkdir -p output
          openssl aes-256-cbc -a -salt -in state_file.json -out state_file.enc -pass env:ENC_KEY -pbkdf2
          
      - name: VerschlÃ¼sselten State auf separaten Branch pushen (Manueller Git-Block) ğŸ’¾
        run: |
          git config user.name "State Update Bot"
          git config user.email "actions@github.com"
          
          git checkout state-storage || git checkout --orphan state-storage
          
          git add state_file.enc
          git commit -m "Auto-update encrypted state"
          
          git push origin state-storage
        
  
    

    
