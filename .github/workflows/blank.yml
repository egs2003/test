name: Vorprüfung

on:
  workflow_dispatch:
    branches:
      - main
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - 'README.md'
      
# Konkurrenz-Kontrolle: Stellt sicher, dass nur ein Workflow-Lauf gleichzeitig aktiv ist.
concurrency: 
  group: workflow_state_update
  cancel-in-progress: true 

env:
  ENC_KEY: ${{ secrets.STATE_ENCRYPTION_KEY }} # Encryption Key als Environment Variable

jobs:
  # Job 1: Alten State holen, entschlüsseln und Vorprüfung durchführen
  prepare_assessment:
    runs-on: self-hosted
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
        
      - name: Alten State holen & entschlüsseln
        run: |
          git fetch origin state-storage:state-storage || true
          git checkout state-storage -- state_file.enc 2>/dev/null || true
          git checkout main 

          if [ -f state_file.enc ]; then
            echo "Alten State entschlüsselt."
            openssl aes-256-cbc -d -a -in state_file.enc -out state_file.json -pass env:ENC_KEY -pbkdf2
            rm state_file.enc
          fi
          
      - name: Vorprüfung (Einschätzung) durchführen
        # Ihr Skript liest state_file.json und schreibt eine Einschätzung in assessment.txt
        run: echo "test123" > lastResult.md
        
      - name: Vorprüfung speichern
        run: |
          git config user.name "State Update Bot"
          git config user.email "actions@github.com"
          
          git checkout state-storage || git checkout --orphan state-storage
          
          git add lastResult.md
          git commit -m "Vorprüfung [skip ci]"
          
          git push origin state-storage
    
