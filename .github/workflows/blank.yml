name: State Update with Review and Encryption

on:
  push:
    branches:
      - main
      
# Konkurrenz-Kontrolle: Stellt sicher, dass nur ein Workflow-Lauf gleichzeitig aktiv ist.
concurrency: 
  group: workflow_state_update
  cancel-in-progress: true 

env:
  ENC_KEY: ${{ secrets.STATE_ENCRYPTION_KEY }} # Encryption Key als Environment Variable

jobs:
  # Job 1: Alten State holen, entschlüsseln und Vorprüfung durchführen
  prepare_assessment:
    runs-on: self-hosted
    outputs: 
      state_available: ${{ steps.fetch_state.outputs.state_available }}
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
        
      - name: Alten State holen & entschlüsseln
        run: |
          git fetch origin state-storage:state-storage || true
          git checkout state-storage -- state_file.enc 2>/dev/null || true
          git checkout main 

          if [ -f state_file.enc ]; then
            echo "Alten State entschlüsselt."
            openssl aes-256-cbc -d -a -in state_file.enc -out state_file.json -pass env:ENC_KEY
            rm state_file.enc
            echo "state_available=true" >> $GITHUB_OUTPUT
          else 
            echo "Keine verschlüsselte Datei gefunden. State NICHT verfügbar (Erster Lauf)."
            echo "state_available=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Vorprüfung (Einschätzung) durchführen
        # Ihr Skript liest state_file.json und schreibt eine Einschätzung in assessment.txt
        run: echo "test" > assessment.txt
        
      - name: Klartext State hochladen (Für den nächsten Job)
        if: steps.fetch_state.outputs.state_available == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: klartext-state
          path: state_file.json
          
      - name: Einschätzung hochladen (Für die manuelle Prüfung)
        uses: actions/upload-artifact@v4
        with:
          name: assessment-report
          path: assessment.txt
  manual_approval:
    needs: prepare_assessment
    runs-on: self-hosted
    environment: 
      name: manuelle_bestaetigung 
    steps:
      - name: Einschätzung für Reviewer herunterladen
        uses: actions/download-artifact@v4
        with:
          name: assessment-report
          path: .
          
      - name: Einschätzung im Log anzeigen
        run: |
          echo "--- BITTE assessment.txt PRÜFEN ---"
          cat assessment.txt
          
  compile_and_deploy:
    needs: manual_approval 
    runs-on: self-hosted
    permissions:
      contents: write 
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
        
      - name: Klartext-State herunterladen (vom Job 1)
        if: needs.prepare_assessment.outputs.state_available == 'true'
        uses: actions/download-artifact@v4
        with:
          name: klartext-state
          path: .
          
      - name: Zustand für Vergleich speichern
        if: needs.prepare_assessment.outputs.state_available == 'true'
        # Der heruntergeladene Zustand (state_file.json) ist der ALTE Zustand.
        # Wir speichern ihn, bevor das Kompilierungsskript ihn verändert.
        run: cp state_file.json old_state_for_comparison.json
          
      - name: Kompilierung und Update der State-Datei
        # Ihr Hauptskript aktualisiert nun state_file.json (den NEUEN Zustand)
        run: echo "next" >> state_file.json
